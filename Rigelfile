# This Rigelfile file was automatically generated by Robotair.
# Feel free to alter it according to your needs.

# For more information on Rigel and Rigelfiles visit:
# https://github.com/rigel-ros/rigel
---

vars:
    distro: "humble"
    dockerfile_plugin: "rigel.plugins.core.DockerfilePlugin"
    buildx_plugin: "rigel.plugins.core.BuildXPlugin"
    test_plugin: "rigel.plugins.core.UnitTestPlugin"
    image_name: "turtle_spiral"

application:
    distro: "{{ vars.distro }}"

providers:

    container_registry_provider_1:
        provider: "rigel.providers.core.ContainerRegistryProvider"
        with:
            server: "https://ghcr.io/"
            username: "robotair-io"
            password: "{{ vars.GITHUB_TOKEN }}"

    ssh_provider_1:
        provider: "rigel.providers.core.SSHProvider"
        with:
            keys:
            -
                hostname: "https://github.com/"
                env: "DEPLOY_KEYS"

jobs:

    dockerfile:
        plugin: "{{ vars.dockerfile_plugin }}"
        with:
            ros_image: "docker.io/library/ros:{{ vars.distro }}-ros-base"
            command: "ros2 launch turtle_draw turtle-draw-bringup.launch.py"
            compiler:
                name: "colcon"
            username: "robotair"
            python_requirements_files:
                - "requirements.txt"
            env:
                -
                    name: "RCUTILS_COLORIZED_OUTPUT"
                    value: "1"
                -
                    name: "RCUTILS_CONSOLE_OUTPUT_FORMAT"
                    value: '"[{severity} {time}] [{name}]: {message}"'

    build:
        plugin: "{{ vars.buildx_plugin }}"
        with:
            image: "{{ vars.image_name }}"
            tags:
                - "latest"
            load: True
            platforms:
                - "linux/amd64"

    build_with_push:
        plugin: "{{ vars.buildx_plugin }}"
        with:
            image: "ghcr.io/robotair-io/rigel-demo"
            tags:
                - "latest"
            load: False
            push: True
            platforms:
                - "linux/amd64"

    test:
        plugin: "{{ vars.test_plugin }}"
        with:
            image: "{{ vars.image_name }}"
            tag: "latest"
            std_output: True
            compiler: "colcon"


sequences:
    robotair:
        stages:
            -
                jobs:
                    - "dockerfile"
                    - "build"
                    - "test"
    # Temporary, until https://github.com/rigel-ros/rigel/pull/38 is merged
    deploy:
        stages:
            -
                jobs:
                    - "dockerfile"
                    - "build_with_push"